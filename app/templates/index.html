<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-800">RAG Chatbot</h1>
                <p class="text-gray-600">Ask questions about your documents</p>
            </div>

            <!-- File Upload Section -->
            <div class="mb-8 p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Upload Documents</h2>
                <form id="uploadForm" class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <input type="file" 
                               class="flex-1 p-2 border rounded"
                               multiple
                               accept=".pdf,.docx,.txt,.md,.png,.jpg,.jpeg">
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                                id="uploadButton">
                            Upload
                        </button>
                    </div>
                    <div id="uploadProgress" class="hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Uploading files...</p>
                    </div>
                </form>
            </div>

            <!-- Web Page Ingestion -->
            <div class="mb-8 p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Ingest Web Page</h2>
                <form id="webForm" class="flex space-x-4">
                    <input type="url" 
                           id="webUrl"
                           placeholder="Enter webpage URL..."
                           class="flex-1 p-2 border rounded"
                           required>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                            id="webButton">
                        Ingest
                    </button>
                </form>
            </div>

            <!-- Chat Interface -->
            <div class="bg-white rounded-lg shadow-md">
                <!-- Chat Messages -->
                <div id="chat-messages" class="p-6 space-y-4 h-96 overflow-y-auto">
                    <!-- Messages will be added here -->
                </div>

                <!-- Input Form -->
                <div class="p-4 border-t">
                    <form id="chatForm" class="flex space-x-4">
                        <input type="text" 
                               id="userInput"
                               placeholder="Type your question..."
                               class="flex-1 p-2 border rounded"
                               required>
                        <button type="submit"
                                class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                                id="sendButton">
                            Send
                        </button>
                    </form>
                </div>

                <!-- Clear History Button -->
                <div class="p-4 border-t text-right">
                    <button id="clearHistory"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Clear History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat JavaScript -->
    <script>
        // Utility function to handle API errors
        async function handleApiResponse(response) {
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'An error occurred');
            }
            return response.json();
        }

        // Utility function to toggle button state
        function toggleButton(button, disabled) {
            button.disabled = disabled;
            if (disabled) {
                button.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Message display function with improved source handling
        function addMessage(type, content, sources = null) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg ${
                type === 'user' ? 'bg-blue-100 ml-12' : 
                type === 'error' ? 'bg-red-100' :
                type === 'info' ? 'bg-gray-100 text-sm' : 'bg-gray-100 mr-12'
            }`;
            
            // Convert markdown to HTML
            const formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .split('\n').join('<br>');

            messageDiv.innerHTML = formattedContent;

            // Add sources if available
            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-2 text-sm text-gray-600';
                sourcesDiv.innerHTML = '<strong>Sources:</strong><br>';
                
                sources.forEach(source => {
                    if (source.type === 'web') {
                        sourcesDiv.innerHTML += `üìÑ <a href="${source.url}" target="_blank" class="text-blue-600 hover:underline">${source.title || source.url}</a><br>`;
                    } else if (source.type === 'file') {
                        sourcesDiv.innerHTML += `üìÅ ${source.path}${source.page ? ` (Page ${source.page})` : ''}<br>`;
                    }
                });
                
                messageDiv.appendChild(sourcesDiv);
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Chat form handler
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const question = input.value.trim();
            if (!question) return;

            // Add user message and clear input
            addMessage('user', question);
            input.value = '';
            toggleButton(sendButton, true);

            try {
                const response = await fetch('/api/v1/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question })
                });

                const data = await handleApiResponse(response);
                addMessage('bot', data.answer, data.sources);
            } catch (error) {
                addMessage('error', `Error: ${error.message}`);
            } finally {
                toggleButton(sendButton, false);
            }
        });

        // File upload handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = e.target.querySelector('input[type="file"]');
            const uploadButton = document.getElementById('uploadButton');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = progressDiv.querySelector('.bg-blue-600');
            const files = fileInput.files;

            if (files.length === 0) return;

            toggleButton(uploadButton, true);
            progressDiv.classList.remove('hidden');
            let processed = 0;

            for (let file of files) {
                const formData = new FormData();
                formData.append('files', file);

                try {
                    const response = await fetch('/api/v1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await handleApiResponse(response);
                    addMessage('bot', `‚úÖ ${file.name}: ${result.message}`);
                } catch (error) {
                    addMessage('error', `Failed to upload ${file.name}: ${error.message}`);
                }

                processed++;
                const progress = (processed / files.length) * 100;
                progressBar.style.width = `${progress}%`;
            }

            fileInput.value = '';
            toggleButton(uploadButton, false);
            setTimeout(() => progressDiv.classList.add('hidden'), 2000);
        });

        // Web page ingestion handler
        document.getElementById('webForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const urlInput = document.getElementById('webUrl');
            const webButton = document.getElementById('webButton');
            const url = urlInput.value.trim();
            if (!url) return;

            toggleButton(webButton, true);

            try {
                const response = await fetch('/api/v1/ingest/webpage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });

                const result = await handleApiResponse(response);
                addMessage('bot', `‚úÖ ${result.message}`);
                urlInput.value = '';
            } catch (error) {
                addMessage('error', `Failed to ingest webpage: ${error.message}`);
            } finally {
                toggleButton(webButton, false);
            }
        });

        // Clear history handler
        document.getElementById('clearHistory').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/v1/chat/clear', {
                    method: 'POST'
                });

                const result = await handleApiResponse(response);
                addMessage('info', result.message);
                
                // Clear visual chat history
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
            } catch (error) {
                addMessage('error', `Failed to clear history: ${error.message}`);
            }
        });
    </script>
</body>
</html> 